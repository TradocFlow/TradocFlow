import { Colors } from "styles/colors.slint";
import { Theme } from "styles/default.slint";
import { MenuBar } from "components/menubar.slint";
import { MarkdownRibbon } from "components/markdown_ribbon.slint";
import { Sidebar } from "components/sidebar.slint";
import { EditorPane } from "components/editor_pane.slint";
import { FocusManager } from "components/focus_management.slint";
import { TextOperation } from "components/enhanced_text_editor.slint";
import { ProjectCreationWizard } from "components/project_creation_wizard.slint";
import { SimpleProjectBrowser, ProjectData } from "components/simple_project_browser.slint";
import { ChunkLinkingPanel, ChunkInfo, PhraseGroup, SelectionMode, MergeStrategy } from "components/chunk_linking_panel.slint";
import { ExportDialog, ExportFormat, ExportLayout, ExportLanguageOption, ExportProgress } from "components/export_dialog.slint";

export component MainWindow inherits Window {
    // Window properties
    title: "Tradocument Reviewer";
    width: 1400px;
    height: 900px;
    
    // Application state
    in-out property <string> current-mode: "markdown";
    in-out property <string> current-layout: "single";
    in-out property <string> current-language: "en";
    in-out property <string> document-content: "# Welcome to Tradocument Reviewer\n\nStart editing your multilingual document here...";
    in-out property <string> translation-content: "";
    
    // Additional content properties for 4-pane layout
    in-out property <string> pane-1-content: "# Welcome to Tradocument Reviewer\n\nStart editing your multilingual document here...";
    in-out property <string> pane-2-content: "";
    in-out property <string> pane-3-content: "";
    in-out property <string> pane-4-content: "";
    in-out property <string> status-message: "Ready";
    in-out property <string> status-type: "info"; // "info", "success", "warning", "error"
    
    // Ribbon state properties
    in-out property <bool> show-ribbon: true;
    in-out property <bool> can-undo: false;
    in-out property <bool> can-redo: false;
    in-out property <bool> has-selection: false;
    
    // Focus management properties
    in-out property <string> active-editor-id: "single-editor";
    in-out property <string> active-pane-id: "single-pane";
    in-out property <bool> single-editor-focused: true;
    in-out property <bool> left-editor-focused: false;
    in-out property <bool> right-editor-focused: false;
    in-out property <bool> pane-1-focused: false;
    in-out property <bool> pane-2-focused: false;
    in-out property <bool> pane-3-focused: false;
    in-out property <bool> pane-4-focused: false;
    
    // Callbacks for application logic
    callback file-new();
    callback file-open();
    callback file-save();
    callback file-save-as();
    callback file-import();
    callback file-export();
    callback file-print();
    callback file-exit();
    
    callback edit-undo();
    callback edit-redo();
    callback edit-cut();
    callback edit-copy();
    callback edit-paste();
    callback edit-find();
    callback edit-replace();
    callback edit-preferences();
    
    callback view-fullscreen();
    callback view-zoom-in();
    callback view-zoom-out();
    callback view-show-sidebar();
    
    callback project-new();
    callback project-open();
    callback project-save();
    callback project-close();
    callback project-properties();
    
    callback translation-add-language();
    callback translation-manage();
    callback translation-export();
    callback translation-import();
    callback translation-validate();
    
    callback tools-screenshot();
    callback tools-spell-check();
    callback tools-word-count();
    callback tools-export-pdf();
    callback tools-export-html();
    callback tools-chunk-linking();
    
    callback help-about();
    callback help-shortcuts();
    callback help-documentation();
    callback help-support();
    
    callback show-projects();
    callback show-kanban();
    callback show-reviews();
    
    // Enhanced sidebar callbacks
    callback new-chapter();
    callback new-translation();
    callback tree-item-clicked(string /* item-id */);
    callback tree-item-expanded(string /* item-id */, bool /* expanded */);
    callback tree-item-context-menu(string /* item-id */, length /* x */, length /* y */);
    callback search-documents(string /* query */);
    callback clear-search();
    callback recent-document-clicked(string /* document-id */);
    callback quick-action-triggered(string /* action-id */);
    
    // Project state properties for sidebar
    in-out property <bool> has-project-loaded: false;
    in-out property <string> current-project-name: "";
    in-out property <string> search-text: "";
    in-out property <string> selected-tree-item: "";
    in-out property <bool> project-tree-collapsed: false;
    in-out property <bool> quick-actions-collapsed: false;
    in-out property <bool> recent-docs-collapsed: false;
    
    // Project wizard state
    in-out property <bool> show-project-wizard: false;
    
    // Project browser state
    in-out property <bool> show-project-browser: false;
    in-out property <[ProjectData]> browser-projects: [];
    in-out property <string> browser-search-query: "";
    in-out property <bool> browser-is-loading: false;
    
    // Chunk linking state
    in-out property <bool> show-chunk-linking: false;
    in-out property <[ChunkInfo]> chunks: [];
    in-out property <[PhraseGroup]> phrase-groups: [];
    in-out property <SelectionMode> chunk-selection-mode: SelectionMode.Individual;
    in-out property <string> chunk-session-id: "";
    in-out property <bool> is-linking-mode: false;
    
    // Export dialog state
    in-out property <bool> show-export-dialog: false;
    in-out property <ExportFormat> export-selected-format: ExportFormat.PDF;
    in-out property <ExportLayout> export-selected-layout: ExportLayout.SingleLanguage;
    in-out property <[ExportLanguageOption]> export-available-languages: [];
    in-out property <string> export-output-directory: "";
    in-out property <string> export-filename-prefix: "document";
    in-out property <bool> export-include-metadata: true;
    in-out property <bool> export-include-table-of-contents: true;
    in-out property <string> export-custom-css-path: "";
    in-out property <bool> export-in-progress: false;
    in-out property <ExportProgress> export-progress: {
        current_step: "",
        progress: 0.0,
        total_files: 0,
        completed_files: 0,
        is_complete: false,
        error_message: "",
    };
    in-out property <int> export-queue-position: 0;
    in-out property <int> export-queue-total: 0;
    in-out property <bool> export-show-queue-info: false;
    
    callback toggle-mode();
    callback set-layout(string);
    callback content-changed(string, string); // content, language
    callback language-changed(string);
    
    // Enhanced formatting callbacks
    callback format-bold();
    callback format-italic();
    callback format-underline();
    callback format-strikethrough();
    callback format-heading(int);
    callback format-code();
    callback format-quote();
    
    // List callbacks
    callback insert-bullet-list();
    callback insert-numbered-list();
    callback insert-checklist();
    
    // Insert callbacks
    callback insert-link();
    callback insert-image();
    callback insert-table();
    callback insert-code-block();
    callback insert-horizontal-rule();
    
    // Text manipulation callbacks
    callback increase-indent();
    callback decrease-indent();
    callback align-left();
    callback align-center();
    callback align-right();
    
    // Undo/Redo callbacks
    callback undo();
    callback redo();
    
    // View toggle callbacks
    callback toggle-preview();
    callback toggle-split-view();
    callback toggle-ribbon();
    
    // Text operation callback
    callback text-operation(TextOperation);
    
    // Legacy callbacks for compatibility
    callback insert-list();
    
    // Focus management callbacks
    callback editor-focus-requested(string /* editor-id */, string /* pane-id */);
    callback editor-focus-granted(string /* editor-id */);
    callback editor-focus-lost(string /* editor-id */);
    callback tab-to-next-editor();
    callback tab-to-previous-editor();
    callback focus-editor-by-index(int /* index */);
    callback update-cursor-position(string /* editor-id */, int /* position */);
    callback update-selection(string /* editor-id */, int /* start */, int /* end */);
    
    callback update-status(string, string); // message, type
    
    // Project wizard callbacks
    callback start-project-wizard();
    callback wizard-step-changed(int /* step */);
    callback wizard-back();
    callback wizard-next();
    callback wizard-cancel();
    callback wizard-finish();
    callback select-folder();
    callback template-selected(string /* template-id */);
    callback language-toggled(string /* language-code */, bool /* enabled */);
    callback source-language-changed(string /* language-code */);
    
    // Project browser callbacks
    callback open-project-browser();
    callback close-project-browser();
    callback browser-search-changed(string /* query */);
    callback browser-filter-changed();
    callback browser-sort-changed(string /* field */, string /* direction */);
    callback browser-view-mode-changed(string /* mode */);
    callback browser-page-changed(int /* page */);
    callback browser-project-selected(ProjectData /* project */);
    callback browser-project-opened(ProjectData /* project */);
    callback browser-refresh-projects();
    callback team-member-added(string /* name */, string /* email */, string /* role */);
    callback team-member-removed(string /* member-id */);
    callback validate-current-step() -> bool;
    
    // Chunk linking callbacks
    callback show-chunk-linking-panel();
    callback hide-chunk-linking-panel();
    callback chunk-selected(string /* chunk-id */, bool /* selected */);
    callback start-chunk-linking-session(SelectionMode /* mode */);
    callback end-chunk-linking-session();
    callback link-selected-chunks(string /* phrase-text */, string /* language */);
    callback unlink-phrase-group(string /* phrase-group-id */);
    callback clear-chunk-selection();
    callback search-phrase-groups(string /* query */);
    callback phrase-group-selected(string /* phrase-group-id */);
    callback chunk-merge-options-changed(MergeStrategy /* strategy */, bool /* preserve-formatting */, bool /* add-spacing */);
    
    // Export dialog callbacks
    callback open-export-dialog();
    callback export-format-changed(ExportFormat);
    callback export-layout-changed(ExportLayout);
    callback export-language-toggled(string /* language-code */, bool /* enabled */);
    callback export-browse-output-directory();
    callback export-browse-custom-css();
    callback export-start();
    callback export-cancel();
    callback export-close-dialog();
    callback export-view-history();
    
    // Global keyboard shortcuts - only handle specific shortcuts, let text input pass through
    key-handler := FocusScope {
        key-pressed(event) => {
            // Only handle Control+ shortcuts, let everything else pass through to text editor
            if (event.modifiers.control) {
                if (event.text == "n") {
                    root.file-new();
                    return accept;
                } else if (event.text == "o") {
                    root.file-open();
                    return accept;
                } else if (event.text == "s") {
                    root.file-save();
                    return accept;
                } else if (event.text == "e") {
                    root.show-export-dialog = true;
                    root.open-export-dialog();
                    return accept;
                } else if (event.text == "m") {
                    root.toggle-mode();
                    return accept;
                } else if (event.text == "1") {
                    root.set-layout("single");
                    return accept;
                } else if (event.text == "2") {
                    root.set-layout("horizontal");
                    return accept;
                } else if (event.text == "3") {
                    root.set-layout("vertical");
                    return accept;
                } else if (event.text == "4") {
                    root.set-layout("grid_2x2");
                    return accept;
                } else if (event.text == "r") {
                    root.toggle-ribbon();
                    return accept;
                } else if (event.text == "p") {
                    root.open-project-browser();
                    return accept;
                } else if (event.text == "l") {
                    root.show-chunk-linking = !root.show-chunk-linking;
                    if (root.show-chunk-linking) {
                        root.show-chunk-linking-panel();
                    } else {
                        root.hide-chunk-linking-panel();
                    }
                    return accept;
                }
                // Let other Ctrl+ shortcuts pass through to text editor (Ctrl+Z, Ctrl+Y, Ctrl+B, etc.)
                return reject;
            } else if (event.text == Key.F11) {
                // Toggle fullscreen
                return accept;
            } else if (event.text == Key.Tab && event.modifiers.control) {
                // Handle Ctrl+Tab navigation between editor panes
                if (event.modifiers.shift) {
                    root.tab-to-previous-editor();
                } else {
                    root.tab-to-next-editor();
                }
                return accept;
            } else if (event.modifiers.alt) {
                // Alt+1-4 for direct editor focus
                if (event.text == "1") {
                    root.focus-editor-by-index(0);
                    return accept;
                } else if (event.text == "2") {
                    root.focus-editor-by-index(1);
                    return accept;
                } else if (event.text == "3") {
                    root.focus-editor-by-index(2);
                    return accept;
                } else if (event.text == "4") {
                    root.focus-editor-by-index(3);
                    return accept;
                }
                return reject;
            } else if (event.text == Key.F11) {
                // Toggle fullscreen
                return accept;
            }
            // Let other Ctrl+ shortcuts pass through to text editor (Ctrl+Z, Ctrl+Y, Ctrl+B, etc.)
            return reject;
        }
    }
    
    VerticalLayout {
        spacing: 0px;
        
        // Top menu bar
        menu-bar := MenuBar {
            // File menu callbacks
            file-new => { root.file-new(); }
            file-open => { root.file-open(); }
            file-save => { root.file-save(); }
            file-save-as => { root.file-save-as(); }
            file-import => { root.file-import(); }
            file-export => { 
                root.show-export-dialog = true;
                root.open-export-dialog();
            }
            file-print => { root.file-print(); }
            file-exit => { root.file-exit(); }
            
            // Edit menu callbacks
            edit-undo => { root.edit-undo(); }
            edit-redo => { root.edit-redo(); }
            edit-cut => { root.edit-cut(); }
            edit-copy => { root.edit-copy(); }
            edit-paste => { root.edit-paste(); }
            edit-find => { root.edit-find(); }
            edit-replace => { root.edit-replace(); }
            edit-preferences => { root.edit-preferences(); }
            
            // View menu callbacks
            view-toggle-mode => { root.toggle-mode(); }
            view-single-pane => { root.set-layout("single"); }
            view-horizontal-split => { root.set-layout("horizontal"); }
            view-vertical-split => { root.set-layout("vertical"); }
            view-grid-split => { root.set-layout("grid_2x2"); }
            view-fullscreen => { root.view-fullscreen(); }
            view-zoom-in => { root.view-zoom-in(); }
            view-zoom-out => { root.view-zoom-out(); }
            view-show-sidebar => { root.view-show-sidebar(); }
            view-toggle-ribbon => { root.toggle-ribbon(); }
            
            // Project menu callbacks
            project-new => { root.project-new(); }
            project-open => { root.project-open(); }
            project-save => { root.project-save(); }
            project-close => { root.project-close(); }
            project-properties => { root.project-properties(); }
            
            // Translation menu callbacks
            translation-add-language => { root.translation-add-language(); }
            translation-manage => { root.translation-manage(); }
            translation-export => { root.translation-export(); }
            translation-import => { root.translation-import(); }
            translation-validate => { root.translation-validate(); }
            
            // Tools menu callbacks
            tools-screenshot => { root.tools-screenshot(); }
            tools-spell-check => { root.tools-spell-check(); }
            tools-word-count => { root.tools-word-count(); }
            tools-export-pdf => { 
                root.export-selected-format = ExportFormat.PDF;
                root.show-export-dialog = true;
                root.open-export-dialog();
            }
            tools-export-html => { 
                root.export-selected-format = ExportFormat.HTML;
                root.show-export-dialog = true;
                root.open-export-dialog();
            }
            tools-chunk-linking => { 
                root.show-chunk-linking = !root.show-chunk-linking;
                if (root.show-chunk-linking) {
                    root.show-chunk-linking-panel();
                } else {
                    root.hide-chunk-linking-panel();
                }
            }
            
            // Help menu callbacks
            help-about => { root.help-about(); }
            help-shortcuts => { root.help-shortcuts(); }
            help-documentation => { root.help-documentation(); }
            help-support => { root.help-support(); }
        }
        
        // Markdown Ribbon
        if root.show-ribbon: markdown-ribbon := MarkdownRibbon {
            enabled: true;
            can-undo: root.can-undo;
            can-redo: root.can-redo;
            has-selection: root.has-selection;
            
            // Basic formatting callbacks
            format-bold => { root.format-bold(); }
            format-italic => { root.format-italic(); }
            format-strikethrough => { root.format-strikethrough(); }
            format-underline => { root.format-underline(); }
            format-code => { root.format-code(); }
            format-quote => { root.format-quote(); }
            format-heading(level) => { root.format-heading(level); }
            
            // List callbacks
            insert-bullet-list => { root.insert-bullet-list(); }
            insert-numbered-list => { root.insert-numbered-list(); }
            insert-checklist => { root.insert-checklist(); }
            
            // Insert callbacks
            insert-link => { root.insert-link(); }
            insert-image => { root.insert-image(); }
            insert-table => { root.insert-table(); }
            insert-code-block => { root.insert-code-block(); }
            insert-horizontal-rule => { root.insert-horizontal-rule(); }
            
            // Text alignment callbacks
            align-left => { root.align-left(); }
            align-center => { root.align-center(); }
            align-right => { root.align-right(); }
            
            // Indentation callbacks
            increase-indent => { root.increase-indent(); }
            decrease-indent => { root.decrease-indent(); }
            
            // Undo/Redo callbacks
            undo => { root.undo(); }
            redo => { root.redo(); }
            
            // View callbacks
            toggle-preview => { root.toggle-preview(); }
            toggle-split-view => { root.toggle-split-view(); }
            
            // File callbacks
            file-new => { root.file-new(); }
            file-open => { root.file-open(); }
            file-save => { root.file-save(); }
            file-export => { 
                root.show-export-dialog = true;
                root.open-export-dialog();
            }
        }
        
        // Main content area
        HorizontalLayout {
            spacing: 0px;
            
            // Left sidebar
            sidebar := Sidebar {
                current-mode: root.current-mode;
                current-layout: root.current-layout;
                has-project-loaded: root.has-project-loaded;
                current-project-name: root.current-project-name;
                search-text: root.search-text;
                selected-tree-item: root.selected-tree-item;
                project-tree-collapsed: root.project-tree-collapsed;
                quick-actions-collapsed: root.quick-actions-collapsed;
                recent-docs-collapsed: root.recent-docs-collapsed;
                
                // Enhanced document actions
                new-document => { root.file-new(); }
                new-chapter => { root.new-chapter(); }
                new-translation => { root.new-translation(); }
                open-document => { root.file-open(); }
                save-document => { root.file-save(); }
                show-projects => { root.show-projects(); }
                show-kanban => { root.show-kanban(); }
                show-reviews => { root.show-reviews(); }
                export-document => { 
                    root.show-export-dialog = true;
                    root.open-export-dialog();
                }
                
                // Project tree callbacks
                tree-item-clicked(item-id) => { 
                    root.selected-tree-item = item-id;
                    root.tree-item-clicked(item-id); 
                }
                tree-item-expanded(item-id, expanded) => { 
                    root.tree-item-expanded(item-id, expanded); 
                }
                tree-item-context-menu(item-id, x, y) => { 
                    root.tree-item-context-menu(item-id, x, y); 
                }
                
                // Search callbacks
                search-documents(query) => { 
                    root.search-text = query;
                    root.search-documents(query); 
                }
                clear-search => { 
                    root.search-text = "";
                    root.clear-search(); 
                }
                
                // Recent documents and quick actions
                recent-document-clicked(doc-id) => { 
                    root.recent-document-clicked(doc-id); 
                }
                quick-action-triggered(action-id) => { 
                    root.quick-action-triggered(action-id); 
                }
                
                // Mode toggle
                toggle-mode => { root.toggle-mode(); }
                
                // Layout controls
                set-single-pane => { root.set-layout("single"); }
                set-horizontal-split => { root.set-layout("horizontal"); }
                set-vertical-split => { root.set-layout("vertical"); }
                set-grid-split => { root.set-layout("grid_2x2"); }
            }
            
            // Main editor area
            editor-container := Rectangle {
                background: Colors.editor-background;
                
                if root.current-layout == "single": VerticalLayout {
                    EditorPane {
                        content: root.document-content;
                        mode: root.current-mode;
                        language: root.current-language;
                        editor-id: "single-editor";
                        pane-id: "single-pane";
                        has-focus: root.single-editor-focused;
                        
                        content-changed(text) => {
                            root.content-changed(text, root.current-language);
                        }
                        
                        language-changed(lang) => {
                            root.language-changed(lang);
                        }
                        
                        // Focus management callbacks
                        focus-requested => {
                            root.editor-focus-requested("single-editor", "single-pane");
                        }
                        
                        focus-granted => {
                            root.single-editor-focused = true;
                            root.active-editor-id = "single-editor";
                            root.active-pane-id = "single-pane";
                            root.editor-focus-granted("single-editor");
                        }
                        
                        focus-lost => {
                            root.single-editor-focused = false;
                            root.editor-focus-lost("single-editor");
                        }
                        
                        text-operation(op) => { root.text-operation(op); }
                        
                        // Enhanced formatting callbacks
                        format-bold => { root.format-bold(); }
                        format-italic => { root.format-italic(); }
                        format-underline => { root.format-underline(); }
                        format-heading(level) => { root.format-heading(level); }
                        format-code => { root.format-code(); }
                        format-quote => { root.format-quote(); }
                        
                        // List callbacks
                        insert-bullet-list => { root.insert-bullet-list(); }
                        insert-numbered-list => { root.insert-numbered-list(); }
                        insert-checklist => { root.insert-checklist(); }
                        insert-list => { root.insert-list(); }
                        
                        // Insert callbacks
                        insert-link => { root.insert-link(); }
                        insert-image => { root.insert-image(); }
                        insert-table => { root.insert-table(); }
                        insert-code-block => { root.insert-code-block(); }
                        
                        // Text manipulation callbacks
                        increase-indent => { root.increase-indent(); }
                        decrease-indent => { root.decrease-indent(); }
                        align-left => { root.align-left(); }
                        align-center => { root.align-center(); }
                        align-right => { root.align-right(); }
                        
                        // Undo/Redo callbacks
                        undo => { root.undo(); }
                        redo => { root.redo(); }
                    }
                }
                
                if root.current-layout == "horizontal": VerticalLayout {
                    EditorPane {
                        content: root.document-content;
                        mode: root.current-mode;
                        language: root.current-language;
                        editor-id: "left-editor";
                        pane-id: "left-pane";
                        has-focus: root.left-editor-focused;
                        
                        content-changed(text) => {
                            root.content-changed(text, root.current-language);
                        }
                        
                        language-changed(lang) => {
                            root.language-changed(lang);
                        }
                        
                        // Focus management callbacks
                        focus-requested => {
                            root.editor-focus-requested("left-editor", "left-pane");
                        }
                        
                        focus-granted => {
                            root.left-editor-focused = true;
                            root.right-editor-focused = false;
                            root.active-editor-id = "left-editor";
                            root.active-pane-id = "left-pane";
                            root.editor-focus-granted("left-editor");
                        }
                        
                        focus-lost => {
                            root.left-editor-focused = false;
                            root.editor-focus-lost("left-editor");
                        }
                        
                        text-operation(op) => { root.text-operation(op); }
                        
                        // Enhanced formatting callbacks
                        format-bold => { root.format-bold(); }
                        format-italic => { root.format-italic(); }
                        format-underline => { root.format-underline(); }
                        format-heading(level) => { root.format-heading(level); }
                        format-code => { root.format-code(); }
                        format-quote => { root.format-quote(); }
                        
                        // List callbacks
                        insert-bullet-list => { root.insert-bullet-list(); }
                        insert-numbered-list => { root.insert-numbered-list(); }
                        insert-checklist => { root.insert-checklist(); }
                        insert-list => { root.insert-list(); }
                        
                        // Insert callbacks
                        insert-link => { root.insert-link(); }
                        insert-image => { root.insert-image(); }
                        insert-table => { root.insert-table(); }
                        insert-code-block => { root.insert-code-block(); }
                        
                        // Text manipulation callbacks
                        increase-indent => { root.increase-indent(); }
                        decrease-indent => { root.decrease-indent(); }
                        align-left => { root.align-left(); }
                        align-center => { root.align-center(); }
                        align-right => { root.align-right(); }
                        
                        // Undo/Redo callbacks
                        undo => { root.undo(); }
                        redo => { root.redo(); }
                    }
                    
                    Rectangle {
                        height: 4px;
                        background: Colors.border;
                    }
                    
                    EditorPane {
                        content: root.translation-content;
                        mode: root.current-mode;
                        language: "de";
                        editor-id: "right-editor";
                        pane-id: "right-pane";
                        has-focus: root.right-editor-focused;
                        
                        content-changed(text) => {
                            root.content-changed(text, "de");
                        }
                        
                        language-changed(lang) => {
                            root.language-changed(lang);
                        }
                        
                        // Focus management callbacks
                        focus-requested => {
                            root.editor-focus-requested("right-editor", "right-pane");
                        }
                        
                        focus-granted => {
                            root.left-editor-focused = false;
                            root.right-editor-focused = true;
                            root.active-editor-id = "right-editor";
                            root.active-pane-id = "right-pane";
                            root.editor-focus-granted("right-editor");
                        }
                        
                        focus-lost => {
                            root.right-editor-focused = false;
                            root.editor-focus-lost("right-editor");
                        }
                        
                        text-operation(op) => { root.text-operation(op); }
                        
                        // Enhanced formatting callbacks
                        format-bold => { root.format-bold(); }
                        format-italic => { root.format-italic(); }
                        format-underline => { root.format-underline(); }
                        format-heading(level) => { root.format-heading(level); }
                        format-code => { root.format-code(); }
                        format-quote => { root.format-quote(); }
                        
                        // List callbacks
                        insert-bullet-list => { root.insert-bullet-list(); }
                        insert-numbered-list => { root.insert-numbered-list(); }
                        insert-checklist => { root.insert-checklist(); }
                        insert-list => { root.insert-list(); }
                        
                        // Insert callbacks
                        insert-link => { root.insert-link(); }
                        insert-image => { root.insert-image(); }
                        insert-table => { root.insert-table(); }
                        insert-code-block => { root.insert-code-block(); }
                        
                        // Text manipulation callbacks
                        increase-indent => { root.increase-indent(); }
                        decrease-indent => { root.decrease-indent(); }
                        align-left => { root.align-left(); }
                        align-center => { root.align-center(); }
                        align-right => { root.align-right(); }
                        
                        // Undo/Redo callbacks
                        undo => { root.undo(); }
                        redo => { root.redo(); }
                    }
                }
                
                if root.current-layout == "vertical": HorizontalLayout {
                    EditorPane {
                        content: root.document-content;
                        mode: root.current-mode;
                        language: root.current-language;
                        
                        content-changed(text) => {
                            root.content-changed(text, root.current-language);
                        }
                        
                        language-changed(lang) => {
                            root.language-changed(lang);
                        }
                        
                        text-operation(op) => { root.text-operation(op); }
                        
                        // Enhanced formatting callbacks
                        format-bold => { root.format-bold(); }
                        format-italic => { root.format-italic(); }
                        format-underline => { root.format-underline(); }
                        format-heading(level) => { root.format-heading(level); }
                        format-code => { root.format-code(); }
                        format-quote => { root.format-quote(); }
                        
                        // List callbacks
                        insert-bullet-list => { root.insert-bullet-list(); }
                        insert-numbered-list => { root.insert-numbered-list(); }
                        insert-checklist => { root.insert-checklist(); }
                        insert-list => { root.insert-list(); }
                        
                        // Insert callbacks
                        insert-link => { root.insert-link(); }
                        insert-image => { root.insert-image(); }
                        insert-table => { root.insert-table(); }
                        insert-code-block => { root.insert-code-block(); }
                        
                        // Text manipulation callbacks
                        increase-indent => { root.increase-indent(); }
                        decrease-indent => { root.decrease-indent(); }
                        align-left => { root.align-left(); }
                        align-center => { root.align-center(); }
                        align-right => { root.align-right(); }
                        
                        // Undo/Redo callbacks
                        undo => { root.undo(); }
                        redo => { root.redo(); }
                    }
                    
                    Rectangle {
                        width: 4px;
                        background: Colors.border;
                    }
                    
                    EditorPane {
                        content: root.translation-content;
                        mode: root.current-mode;
                        language: "de";
                        
                        content-changed(text) => {
                            root.content-changed(text, "de");
                        }
                        
                        language-changed(lang) => {
                            root.language-changed(lang);
                        }
                        
                        text-operation(op) => { root.text-operation(op); }
                        
                        // Enhanced formatting callbacks
                        format-bold => { root.format-bold(); }
                        format-italic => { root.format-italic(); }
                        format-underline => { root.format-underline(); }
                        format-heading(level) => { root.format-heading(level); }
                        format-code => { root.format-code(); }
                        format-quote => { root.format-quote(); }
                        
                        // List callbacks
                        insert-bullet-list => { root.insert-bullet-list(); }
                        insert-numbered-list => { root.insert-numbered-list(); }
                        insert-checklist => { root.insert-checklist(); }
                        insert-list => { root.insert-list(); }
                        
                        // Insert callbacks
                        insert-link => { root.insert-link(); }
                        insert-image => { root.insert-image(); }
                        insert-table => { root.insert-table(); }
                        insert-code-block => { root.insert-code-block(); }
                        
                        // Text manipulation callbacks
                        increase-indent => { root.increase-indent(); }
                        decrease-indent => { root.decrease-indent(); }
                        align-left => { root.align-left(); }
                        align-center => { root.align-center(); }
                        align-right => { root.align-right(); }
                        
                        // Undo/Redo callbacks
                        undo => { root.undo(); }
                        redo => { root.redo(); }
                    }
                }
                
                if root.current-layout == "grid_2x2": VerticalLayout {
                    // Top row with two panes
                    HorizontalLayout {
                        // Top-left pane
                        EditorPane {
                            content: root.pane-1-content;
                            mode: root.current-mode;
                            language: root.current-language;
                            editor-id: "pane-1-editor";
                            pane-id: "pane-1";
                            has-focus: root.pane-1-focused;
                            
                            content-changed(text) => {
                                root.pane-1-content = text;
                                root.content-changed(text, root.current-language);
                            }
                            
                            language-changed(lang) => {
                                root.language-changed(lang);
                            }
                            
                            // Focus management callbacks
                            focus-requested => {
                                root.editor-focus-requested("pane-1-editor", "pane-1");
                            }
                            
                            focus-granted => {
                                root.pane-1-focused = true;
                                root.pane-2-focused = false;
                                root.pane-3-focused = false;
                                root.pane-4-focused = false;
                                root.active-editor-id = "pane-1-editor";
                                root.active-pane-id = "pane-1";
                                root.editor-focus-granted("pane-1-editor");
                            }
                            
                            focus-lost => {
                                root.pane-1-focused = false;
                                root.editor-focus-lost("pane-1-editor");
                            }
                            
                            text-operation(op) => { root.text-operation(op); }
                            
                            // Enhanced formatting callbacks
                            format-bold => { root.format-bold(); }
                            format-italic => { root.format-italic(); }
                            format-underline => { root.format-underline(); }
                            format-heading(level) => { root.format-heading(level); }
                            format-code => { root.format-code(); }
                            format-quote => { root.format-quote(); }
                            
                            // List callbacks
                            insert-bullet-list => { root.insert-bullet-list(); }
                            insert-numbered-list => { root.insert-numbered-list(); }
                            insert-checklist => { root.insert-checklist(); }
                            insert-list => { root.insert-list(); }
                            
                            // Insert callbacks
                            insert-link => { root.insert-link(); }
                            insert-image => { root.insert-image(); }
                            insert-table => { root.insert-table(); }
                            insert-code-block => { root.insert-code-block(); }
                            
                            // Text manipulation callbacks
                            increase-indent => { root.increase-indent(); }
                            decrease-indent => { root.decrease-indent(); }
                            align-left => { root.align-left(); }
                            align-center => { root.align-center(); }
                            align-right => { root.align-right(); }
                            
                            // Undo/Redo callbacks
                            undo => { root.undo(); }
                            redo => { root.redo(); }
                        }
                        
                        // Vertical divider
                        Rectangle {
                            width: 4px;
                            background: Colors.border;
                        }
                        
                        // Top-right pane
                        EditorPane {
                            content: root.pane-2-content;
                            mode: root.current-mode;
                            language: "de";
                            editor-id: "pane-2-editor";
                            pane-id: "pane-2";
                            has-focus: root.pane-2-focused;
                            
                            content-changed(text) => {
                                root.pane-2-content = text;
                                root.content-changed(text, "de");
                            }
                            
                            language-changed(lang) => {
                                root.language-changed(lang);
                            }
                            
                            // Focus management callbacks
                            focus-requested => {
                                root.editor-focus-requested("pane-2-editor", "pane-2");
                            }
                            
                            focus-granted => {
                                root.pane-1-focused = false;
                                root.pane-2-focused = true;
                                root.pane-3-focused = false;
                                root.pane-4-focused = false;
                                root.active-editor-id = "pane-2-editor";
                                root.active-pane-id = "pane-2";
                                root.editor-focus-granted("pane-2-editor");
                            }
                            
                            focus-lost => {
                                root.pane-2-focused = false;
                                root.editor-focus-lost("pane-2-editor");
                            }
                            
                            text-operation(op) => { root.text-operation(op); }
                            
                            // Enhanced formatting callbacks
                            format-bold => { root.format-bold(); }
                            format-italic => { root.format-italic(); }
                            format-underline => { root.format-underline(); }
                            format-heading(level) => { root.format-heading(level); }
                            format-code => { root.format-code(); }
                            format-quote => { root.format-quote(); }
                            
                            // List callbacks
                            insert-bullet-list => { root.insert-bullet-list(); }
                            insert-numbered-list => { root.insert-numbered-list(); }
                            insert-checklist => { root.insert-checklist(); }
                            insert-list => { root.insert-list(); }
                            
                            // Insert callbacks
                            insert-link => { root.insert-link(); }
                            insert-image => { root.insert-image(); }
                            insert-table => { root.insert-table(); }
                            insert-code-block => { root.insert-code-block(); }
                            
                            // Text manipulation callbacks
                            increase-indent => { root.increase-indent(); }
                            decrease-indent => { root.decrease-indent(); }
                            align-left => { root.align-left(); }
                            align-center => { root.align-center(); }
                            align-right => { root.align-right(); }
                            
                            // Undo/Redo callbacks
                            undo => { root.undo(); }
                            redo => { root.redo(); }
                        }
                    }
                    
                    // Horizontal divider
                    Rectangle {
                        height: 4px;
                        background: Colors.border;
                    }
                    
                    // Bottom row with two panes
                    HorizontalLayout {
                        // Bottom-left pane
                        EditorPane {
                            content: root.pane-3-content;
                            mode: root.current-mode;
                            language: "fr";
                            editor-id: "pane-3-editor";
                            pane-id: "pane-3";
                            has-focus: root.pane-3-focused;
                            
                            content-changed(text) => {
                                root.pane-3-content = text;
                                root.content-changed(text, "fr");
                            }
                            
                            language-changed(lang) => {
                                root.language-changed(lang);
                            }
                            
                            // Focus management callbacks
                            focus-requested => {
                                root.editor-focus-requested("pane-3-editor", "pane-3");
                            }
                            
                            focus-granted => {
                                root.pane-1-focused = false;
                                root.pane-2-focused = false;
                                root.pane-3-focused = true;
                                root.pane-4-focused = false;
                                root.active-editor-id = "pane-3-editor";
                                root.active-pane-id = "pane-3";
                                root.editor-focus-granted("pane-3-editor");
                            }
                            
                            focus-lost => {
                                root.pane-3-focused = false;
                                root.editor-focus-lost("pane-3-editor");
                            }
                            
                            text-operation(op) => { root.text-operation(op); }
                            
                            // Enhanced formatting callbacks
                            format-bold => { root.format-bold(); }
                            format-italic => { root.format-italic(); }
                            format-underline => { root.format-underline(); }
                            format-heading(level) => { root.format-heading(level); }
                            format-code => { root.format-code(); }
                            format-quote => { root.format-quote(); }
                            
                            // List callbacks
                            insert-bullet-list => { root.insert-bullet-list(); }
                            insert-numbered-list => { root.insert-numbered-list(); }
                            insert-checklist => { root.insert-checklist(); }
                            insert-list => { root.insert-list(); }
                            
                            // Insert callbacks
                            insert-link => { root.insert-link(); }
                            insert-image => { root.insert-image(); }
                            insert-table => { root.insert-table(); }
                            insert-code-block => { root.insert-code-block(); }
                            
                            // Text manipulation callbacks
                            increase-indent => { root.increase-indent(); }
                            decrease-indent => { root.decrease-indent(); }
                            align-left => { root.align-left(); }
                            align-center => { root.align-center(); }
                            align-right => { root.align-right(); }
                            
                            // Undo/Redo callbacks
                            undo => { root.undo(); }
                            redo => { root.redo(); }
                        }
                        
                        // Vertical divider
                        Rectangle {
                            width: 4px;
                            background: Colors.border;
                        }
                        
                        // Bottom-right pane
                        EditorPane {
                            content: root.pane-4-content;
                            mode: root.current-mode;
                            language: "es";
                            editor-id: "pane-4-editor";
                            pane-id: "pane-4";
                            has-focus: root.pane-4-focused;
                            
                            content-changed(text) => {
                                root.pane-4-content = text;
                                root.content-changed(text, "es");
                            }
                            
                            language-changed(lang) => {
                                root.language-changed(lang);
                            }
                            
                            // Focus management callbacks
                            focus-requested => {
                                root.editor-focus-requested("pane-4-editor", "pane-4");
                            }
                            
                            focus-granted => {
                                root.pane-1-focused = false;
                                root.pane-2-focused = false;
                                root.pane-3-focused = false;
                                root.pane-4-focused = true;
                                root.active-editor-id = "pane-4-editor";
                                root.active-pane-id = "pane-4";
                                root.editor-focus-granted("pane-4-editor");
                            }
                            
                            focus-lost => {
                                root.pane-4-focused = false;
                                root.editor-focus-lost("pane-4-editor");
                            }
                            
                            text-operation(op) => { root.text-operation(op); }
                            
                            // Enhanced formatting callbacks
                            format-bold => { root.format-bold(); }
                            format-italic => { root.format-italic(); }
                            format-underline => { root.format-underline(); }
                            format-heading(level) => { root.format-heading(level); }
                            format-code => { root.format-code(); }
                            format-quote => { root.format-quote(); }
                            
                            // List callbacks
                            insert-bullet-list => { root.insert-bullet-list(); }
                            insert-numbered-list => { root.insert-numbered-list(); }
                            insert-checklist => { root.insert-checklist(); }
                            insert-list => { root.insert-list(); }
                            
                            // Insert callbacks
                            insert-link => { root.insert-link(); }
                            insert-image => { root.insert-image(); }
                            insert-table => { root.insert-table(); }
                            insert-code-block => { root.insert-code-block(); }
                            
                            // Text manipulation callbacks
                            increase-indent => { root.increase-indent(); }
                            decrease-indent => { root.decrease-indent(); }
                            align-left => { root.align-left(); }
                            align-center => { root.align-center(); }
                            align-right => { root.align-right(); }
                            
                            // Undo/Redo callbacks
                            undo => { root.undo(); }
                            redo => { root.redo(); }
                        }
                    }
                }
            }
            
            // Chunk linking panel (right side)
            if root.show-chunk-linking: chunk-linking-panel := ChunkLinkingPanel {
                width: 350px;
                panel-visible: root.show-chunk-linking;
                chunks: root.chunks;
                phrase-groups: root.phrase-groups;
                selection-mode: root.chunk-selection-mode;
                session-id: root.chunk-session-id;
                is-linking-mode: root.is-linking-mode;
                
                chunk-selected(chunk-id, selected) => {
                    root.chunk-selected(chunk-id, selected);
                }
                
                start-linking-session(mode) => {
                    root.chunk-selection-mode = mode;
                    root.is-linking-mode = true;
                    root.start-chunk-linking-session(mode);
                }
                
                end-linking-session => {
                    root.is-linking-mode = false;
                    root.end-chunk-linking-session();
                }
                
                link-selected-chunks(phrase-text, language) => {
                    root.link-selected-chunks(phrase-text, language);
                }
                
                unlink-phrase-group(phrase-group-id) => {
                    root.unlink-phrase-group(phrase-group-id);
                }
                
                clear-selection => {
                    root.clear-chunk-selection();
                }
                
                search-phrases(query) => {
                    root.search-phrase-groups(query);
                }
                
                phrase-group-selected(phrase-group-id) => {
                    root.phrase-group-selected(phrase-group-id);
                }
                
                merge-options-changed(strategy, preserve-formatting, add-spacing) => {
                    root.chunk-merge-options-changed(strategy, preserve-formatting, add-spacing);
                }
            }
        }
        
        // Status bar
        status-bar := Rectangle {
            height: 24px;
            background: Colors.surface;
            border-width: 1px;
            border-color: Colors.border;
            
            HorizontalLayout {
                padding-left: Theme.spacing-sm;
                padding-right: Theme.spacing-sm;
                alignment: space-between;
                
                HorizontalLayout {
                    spacing: Theme.spacing-lg;
                    alignment: start;
                    
                    Text {
                        text: "Mode: " + root.current-mode;
                        font-size: Theme.font-size-small;
                        color: Colors.text-secondary;
                        vertical-alignment: center;
                    }
                    
                    Text {
                        text: "Layout: " + root.current-layout;
                        font-size: Theme.font-size-small;
                        color: Colors.text-secondary;
                        vertical-alignment: center;
                    }
                    
                    Text {
                        text: "Language: " + root.current-language;
                        font-size: Theme.font-size-small;
                        color: Colors.text-secondary;
                        vertical-alignment: center;
                    }
                }
                
                HorizontalLayout {
                    spacing: Theme.spacing-md;
                    alignment: end;
                    
                    Text {
                        text: root.status-message;
                        font-size: Theme.font-size-small;
                        color: root.status-type == "success" ? Colors.success :
                               root.status-type == "warning" ? Colors.warning :
                               root.status-type == "error" ? Colors.error :
                               Colors.text-secondary;
                        vertical-alignment: center;
                    }
                }
            }
        }
        
        // Project Creation Wizard (modal dialog)
        if show-project-wizard: project-wizard := ProjectCreationWizard {
            wizard-step-changed(step) => { root.wizard-step-changed(step); }
            wizard-back => { root.wizard-back(); }
            wizard-next => { root.wizard-next(); }
            wizard-cancel => { 
                root.show-project-wizard = false;
                root.wizard-cancel(); 
            }
            wizard-finish => { 
                root.wizard-finish();
                root.show-project-wizard = false;
            }
            select-folder => { root.select-folder(); }
            template-selected(template-id) => { root.template-selected(template-id); }
            language-toggled(code, enabled) => { root.language-toggled(code, enabled); }
            source-language-changed(code) => { root.source-language-changed(code); }
            team-member-added(name, email, role) => { root.team-member-added(name, email, role); }
            team-member-removed(id) => { root.team-member-removed(id); }
            validate-current-step() => { return root.validate-current-step(); }
        }
        
        // Project Browser (modal dialog)
        if show-project-browser: simple-project-browser := SimpleProjectBrowser {
            projects: root.browser-projects;
            search-query: root.browser-search-query;
            is-loading: root.browser-is-loading;
            
            search-changed(query) => { 
                root.browser-search-query = query;
                root.browser-search-changed(query); 
            }
            project-selected(project) => { 
                root.show-project-browser = false;
                root.browser-project-opened(project); 
            }
            close-dialog => { 
                root.show-project-browser = false;
                root.close-project-browser(); 
            }
        }
        
        // Export Dialog (modal dialog)
        if show-export-dialog: export-dialog := ExportDialog {
            selected-format: root.export-selected-format;
            selected-layout: root.export-selected-layout;
            available-languages: root.export-available-languages;
            output-directory: root.export-output-directory;
            filename-prefix: root.export-filename-prefix;
            include-metadata: root.export-include-metadata;
            include-table-of-contents: root.export-include-table-of-contents;
            custom-css-path: root.export-custom-css-path;
            export-in-progress: root.export-in-progress;
            export-progress: root.export-progress;
            queue-position: root.export-queue-position;
            queue-total: root.export-queue-total;
            show-queue-info: root.export-show-queue-info;
            
            format-changed(format) => { 
                root.export-selected-format = format;
                root.export-format-changed(format); 
            }
            layout-changed(layout) => { 
                root.export-selected-layout = layout;
                root.export-layout-changed(layout); 
            }
            language-toggled(code, enabled) => { 
                root.export-language-toggled(code, enabled); 
            }
            browse-output-directory => { 
                root.export-browse-output-directory(); 
            }
            browse-custom-css => { 
                root.export-browse-custom-css(); 
            }
            start-export => { 
                root.export-start(); 
            }
            cancel-export => { 
                root.export-cancel(); 
            }
            close-dialog => { 
                root.show-export-dialog = false;
                root.export-close-dialog(); 
            }
            view-export-history => { 
                root.export-view-history(); 
            }
        }
    }
}
